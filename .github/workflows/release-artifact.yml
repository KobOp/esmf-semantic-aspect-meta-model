name: Release Artifact
on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Version number of the release'
        required: true
jobs:
  build-and-release:
    env:
      OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
      OSSRH_TOKEN: ${{ secrets.OSSRH_TOKEN }}
      PGP_KEY: ${{ secrets.PGP_KEY }}
      PGP_KEY_PASSWORD: ${{ secrets.PGP_KEY_PASSWORD }}

    runs-on: ubuntu-20.04

    steps:
    - name: Checkout
      uses: actions/checkout@v2.3.1

    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: Cache Maven packages
      id: cache-maven
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: maven-${{ hashFiles('**/pom.xml') }}

    - name: Cache node and node_modules
      id: cache-node
      uses: actions/cache@v3
      with:
        path: |
          documentation/node
          documentation/node_modules
        key: node-${{ hashFiles('documentation/package-lock.json') }}

    - name: Create release branch if not exists
      continue-on-error: true
      run: |
        release_version=${{ github.event.inputs.release_version }}
        release_branch_name=${release_version%.*}.x
        echo "release_branch_name=$release_branch_name" >> $GITHUB_ENV

        git fetch
        git checkout -b $release_branch_name --track origin/$release_branch_name || true
        git checkout -b $release_branch_name

    - name: Set release version in antora.yml
      uses: mikefarah/yq@master
      with:
        cmd: yq eval -i '.version = "${{ github.event.inputs.release_version }}"' documentation/antora.yml

    - name: Build SAMM artifact and release to OSSRH
      run: |
        ./mvnw versions:set -DnewVersion=${{ github.event.inputs.release_version }}
        ./mvnw versions:commit
        ./mvnw generate-resources -pl documentation -Pantora
        ./mvnw clean install -pl esmf-samm-build-plugin
        ./mvnw clean deploy -pl esmf-semantic-aspect-meta-model -Psign
        cd build/
        mv site SAMM-${{ github.events.inputs.release_version }}
        zip -r ../SAMM-${{ github.events.inputs.release_version }}-specification.zip SAMM-${{ github.events.inputs.release_version }}

    # If the deployment to OSSRH went through, the following steps will
    # - Commit updated version to release branch
    # - Create Github release

    - name: Commit version changes and push to upstream repository
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add .
        if git commit -m "Add version ${{ github.event.inputs.release_version }}"; then
          git push origin ${{ env.release_branch_name }}
        fi

    - name: Create GitHub release
      uses: softprops/action-gh-release@v1
      with:
        body: "Create Github release"
        tag_name: v${{ github.event.inputs.release_version }}
        target_commitish: ${{ env.release_branch_name }}
        draft: false
        prerelease: false
        files: |
          esmf-semantic-aspect-meta-model/target/*.jar
          SAMM-*-specification.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN  }}

